<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BeatSynth ‚Äì Browser Beatmaker & Synth</title>
<style>
  :root{
    --bg:#0f1117;
    --panel:#171923;
    --panel2:#1f2230;
    --accent:#8bd450;
    --accent2:#55d0ff;
    --text:#e7e9ee;
    --muted:#a7acb8;
    --danger:#ff6b6b;
    --ok:#3ddc97;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  }
  header{
    display:flex; gap:16px; align-items:center; justify-content:space-between;
    padding:14px 16px; background:linear-gradient(180deg,var(--panel2),var(--panel));
    position:sticky; top:0; z-index:10; box-shadow:0 2px 0 rgba(0,0,0,.2);
  }
  header h1{ font-size:18px; margin:0; letter-spacing:.5px }
  .controls{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .controls > * { background:var(--panel2); padding:8px 10px; border-radius:8px; border:1px solid #2a2e42 }
  .btn{
    border:1px solid #2a2e42; border-radius:8px; padding:8px 12px; background:var(--panel2);
    color:var(--text); cursor:pointer; transition:transform .02s ease;
    user-select:none;
  }
  .btn:active{ transform:translateY(1px) }
  .btn.primary{ background:linear-gradient(180deg,var(--accent2),#2aa7d8); color:#001018; border:none; font-weight:600 }
  .btn.play{ background:linear-gradient(180deg,var(--accent),#5db53d); color:#031005; border:none; font-weight:700 }
  .btn.rec{ background:linear-gradient(180deg,#ff6b6b,#e94d4d); color:#2a0000; font-weight:700 }
  .btn.small{ padding:6px 8px; font-size:12px }
  .led{ width:10px; height:10px; border-radius:50%; background:#3a3f55; display:inline-block; margin-left:6px; box-shadow:0 0 0 1px #0006 inset }
  .led.on{ background:var(--ok); box-shadow:0 0 6px var(--ok) }
  main{ display:grid; gap:14px; padding:14px; grid-template-columns: 1.2fr 1fr }
  section{ background:var(--panel); border:1px solid #2a2e42; border-radius:12px; padding:12px }
  h2{ margin:4px 0 10px; font-size:16px }
  .grid{
    display:grid; gap:6px;
    grid-template-columns: 120px repeat(16, 1fr);
    align-items:center;
  }
  .row-label{ opacity:.85; font-size:14px; text-align:right; padding-right:8px }
  .step{
    height:28px; border-radius:6px; background:#21263a; border:1px solid #2b3050; cursor:pointer;
    position:relative; outline:none;
  }
  .step.on{ background:linear-gradient(180deg,#38406a,#2b3357); border-color:#3c4782 }
  .step:nth-child(4n+2):not(.on){ background:#1f2436 }
  .step.playhead{ box-shadow:0 0 0 2px var(--accent2) inset, 0 0 8px #55d0ff55 }
  .param{
    display:grid; grid-template-columns: 140px 1fr 60px; gap:8px; align-items:center; margin:6px 0;
  }
  input[type=range]{ width:100% }
  .tags{ display:flex; gap:6px; flex-wrap:wrap; }
  .tag{ font-size:12px; color:var(--muted); background:#151827; border:1px solid #2a2e42; padding:4px 6px; border-radius:6px }
  /* Synth keys */
  .keyboard{ position:relative; height:160px; background:#111525; border-radius:8px; border:1px solid #2a2e42; padding:10px; user-select:none }
  .keys{ position:absolute; left:10px; right:10px; bottom:10px; top:10px; display:flex }
  .white{ flex:1; background:#e6ecff; border:1px solid #c9d2ff; border-bottom:4px solid #a9b7ff; margin:0 1px; border-radius:0 0 6px 6px; position:relative }
  .white.active{ background:#b8c6ff }
  .black{ position:absolute; width:60%; height:65%; right:-30%; top:0; background:#1a1d2b; border:1px solid #3a3f55; border-bottom:4px solid #2a2e42; border-radius:0 0 4px 4px; z-index:2 }
  .black.active{ background:#333a55 }
  .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .split{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
  textarea{ width:100%; min-height:90px; background:#0e1222; color:var(--text); border:1px solid #2a2e42; border-radius:8px; padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace }
  .footer{
    padding:10px 14px; text-align:center; color:var(--muted);
  }
  .select, select, input[type=number]{
    background:#0e1222; color:var(--text); border:1px solid #2a2e42; border-radius:8px; padding:6px 8px;
  }
  .meter{ height:8px; background:#1b1f2f; border:1px solid #2a2e42; border-radius:6px; overflow:hidden }
  .meter > div{ height:100%; width:0%; background:linear-gradient(90deg,#55d0ff,#8bd450) }
  .right{ text-align:right }
  .nowrap{ white-space:nowrap }
  @media (max-width: 980px){
    main{ grid-template-columns: 1fr }
  }
</style>
</head>
<body>
<header>
  <h1>üéõÔ∏è BeatSynth <span class="tag">WebAudio</span></h1>
  <div class="controls">
    <div class="flex">
      <label class="nowrap">BPM
        <input id="bpm" type="number" value="110" min="50" max="220" style="width:72px;margin-left:6px">
      </label>
      <label class="nowrap">Swing
        <input id="swing" type="range" min="0" max="100" value="0">
      </label>
    </div>
    <button id="play" class="btn play">‚ñ∂Ô∏é Play</button>
    <button id="stop" class="btn">‚ñ† Stop</button>
    <button id="rec" class="btn rec">‚óè Record</button><span id="recLed" class="led"></span>
    <button id="save" class="btn small">Save Pattern</button>
    <button id="load" class="btn small">Load Pattern</button>
    <button id="exportJSON" class="btn small">Export JSON</button>
    <input id="importJSON" type="file" accept=".json" style="display:none">
    <button id="importBtn" class="btn small">Import</button>
  </div>
</header>

<main>
  <section>
    <h2>ü™ò Drum Machine <span class="tag">16-step</span></h2>
    <div id="drumGrid" class="grid"></div>
    <div class="split">
      <div>
        <h3 style="margin-top:12px">Drum Engine</h3>
        <div class="param"><label>Kick Tone</label><input id="kickTone" type="range" min="40" max="120" value="60"><span id="kickToneVal">60</span></div>
        <div class="param"><label>Snare Noise</label><input id="snrNoise" type="range" min="0" max="1" value="0.6" step="0.01"><span id="snrNoiseVal">0.60</span></div>
        <div class="param"><label>Hat Decay</label><input id="hatDecay" type="range" min="0.01" max="0.5" step="0.01" value="0.12"><span id="hatDecayVal">0.12</span></div>
      </div>
      <div>
        <h3 style="margin-top:12px">Mix</h3>
        <div class="param"><label>Drum Volume</label><input id="drumVol" type="range" min="-24" max="6" step="0.1" value="-2"><span id="drumVolVal">-2 dB</span></div>
        <div class="param"><label>Master Volume</label><input id="masterVol" type="range" min="-36" max="6" step="0.1" value="-6"><span id="masterVolVal">-6 dB</span></div>
        <div class="param"><label>Output</label><div class="meter"><div id="meterBar"></div></div><span id="dbNow">0 dB</span></div>
      </div>
    </div>
  </section>

  <section>
    <h2>üéπ Synth <span class="tag">poly</span></h2>
    <div class="flex" style="margin-bottom:8px">
      <label>Wave
        <select id="wave">
          <option>sawtooth</option>
          <option>square</option>
          <option>triangle</option>
          <option selected>sine</option>
        </select>
      </label>
      <label class="nowrap">Attack <input id="a" type="range" min="0" max="1" step="0.005" value="0.01"></label>
      <label class="nowrap">Decay <input id="d" type="range" min="0" max="1" step="0.005" value="0.2"></label>
      <label class="nowrap">Sustain <input id="s" type="range" min="0" max="1" step="0.01" value="0.6"></label>
      <label class="nowrap">Release <input id="r" type="range" min="0" max="2" step="0.01" value="0.5"></label>
    </div>
    <div class="flex" style="margin-bottom:8px">
      <label class="nowrap">Filter Cutoff <input id="cutoff" type="range" min="100" max="12000" value="1800"></label>
      <label class="nowrap">Resonance <input id="q" type="range" min="0.1" max="20" step="0.1" value="1.5"></label>
      <label class="nowrap">Delay Mix <input id="delayMix" type="range" min="0" max="0.9" step="0.01" value="0.2"></label>
      <label class="nowrap">Delay Time <input id="delayTime" type="range" min="0.05" max="0.6" step="0.01" value="0.28"></label>
      <label class="nowrap">Reverb <input id="reverb" type="range" min="0" max="0.9" step="0.01" value="0.15"></label>
      <label class="nowrap">Synth Vol <input id="synthVol" type="range" min="-24" max="6" step="0.1" value="-6"></label>
    </div>
    <div class="keyboard">
      <div id="keys" class="keys"></div>
    </div>
    <div class="tags" style="margin-top:8px">
      <span class="tag">Type to play: Z S X D C V G B H N J M</span>
      <span class="tag">Hold Shift for octave up</span>
      <span class="tag">Poly up to 8 notes</span>
    </div>
  </section>

  <section class="split" style="grid-column:1/-1">
    <div>
      <h2>üìº Pattern JSON</h2>
      <textarea id="patternBox" placeholder='Click "Export JSON" to see your pattern here, or paste JSON and click "Import".'></textarea>
    </div>
    <div>
      <h2>‚¨áÔ∏è Recording</h2>
      <p>Click <b>Record</b> to capture audio to WAV, then your browser will download it automatically.</p>
      <div class="tags">
        <span class="tag">Non-destructive</span>
        <span class="tag">Live performance</span>
        <span class="tag">Local only</span>
      </div>
    </div>
  </section>
</main>

<div class="footer">Built with ‚ù§Ô∏è using the Web Audio API. Tip: try 128 BPM, swing 12‚Äì18, saw synth, cutoff ~2.5k, delay 0.24.</div>

<script>
(function(){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let isPlaying=false, currentStep=0, timer=null, lookahead=25, scheduleAhead=0.1;
  const steps = 16;
  // Master
  const masterGain = ctx.createGain(); dbToGain(masterGain, -6); masterGain.connect(ctx.destination);
  const analyser = ctx.createAnalyser(); analyser.fftSize=512; const meterDest = ctx.createGain(); meterDest.gain.value=1;
  masterGain.connect(analyser); masterGain.connect(meterDest);
  // For recording
  const mediaDest = ctx.createMediaStreamDestination();
  masterGain.connect(mediaDest);
  let mediaRecorder=null, recordedChunks=[], recLed=document.getElementById('recLed');

  // Simple dynamics for snappier output
  const comp = ctx.createDynamicsCompressor();
  comp.threshold.value=-16; comp.knee.value=20; comp.ratio.value=2.2; comp.attack.value=0.003; comp.release.value=0.25;
  comp.connect(masterGain);

  // Global Drum bus
  const drumBus = ctx.createGain(); drumBus.connect(comp);
  const drumVol = document.getElementById('drumVol'); const drumVolVal=document.getElementById('drumVolVal');
  function dbToGain(node, db){ node.gain.value = Math.pow(10, db/20); }
  function gainToDb(g){ return 20*Math.log10(g); }
  function setDb(node, db){ dbToGain(node, db); }
  function clamp(v, a, b){ return Math.min(b, Math.max(a, v)); }

  // Meter
  const meterBar = document.getElementById('meterBar'); const dbNowEl=document.getElementById('dbNow');
  function updateMeter(){
    const arr = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteTimeDomainData(arr);
    let sum=0;
    for(let i=0;i<arr.length;i++){ const v=(arr[i]-128)/128; sum += v*v; }
    const rms = Math.sqrt(sum/arr.length);
    const db = 20*Math.log10(rms||1e-8);
    meterBar.style.width = clamp((db+60)/60*100,0,100)+'%';
    dbNowEl.textContent = db.toFixed(1)+' dB';
    requestAnimationFrame(updateMeter);
  }
  updateMeter();

  // Sequencer state
  const tracks = [
    {name:'Kick', type:'kick', steps:Array(steps).fill(false)},
    {name:'Snare', type:'snare', steps:Array(steps).fill(false)},
    {name:'Hat', type:'hat', steps:Array(steps).fill(false)},
    {name:'Clap', type:'clap', steps:Array(steps).fill(false)},
  ];

  // UI build: drum grid
  const drumGrid = document.getElementById('drumGrid');
  function buildGrid(){
    drumGrid.innerHTML='';
    tracks.forEach((t, ri)=>{
      const label = document.createElement('div'); label.className='row-label'; label.textContent=t.name;
      drumGrid.appendChild(label);
      for(let i=0;i<steps;i++){
        const btn = document.createElement('button'); btn.className = 'step'; btn.setAttribute('data-ri', ri); btn.setAttribute('data-i', i);
        btn.addEventListener('click', ()=>{
          t.steps[i]=!t.steps[i];
          btn.classList.toggle('on', t.steps[i]);
        });
        drumGrid.appendChild(btn);
      }
    });
  }
  buildGrid();

  function setPlayheadUI(stepIdx){
    const nodes = drumGrid.querySelectorAll('.step');
    nodes.forEach(n=>n.classList.remove('playhead'));
    // apply on current column
    for(let r=0;r<tracks.length;r++){
      const idx = r*(steps+1) + 1 + stepIdx; // account for label every row
      const btn = nodes[idx];
      if(btn) btn.classList.add('playhead');
    }
  }

  // Drum synthesis
  function playKick(t, tone=60){
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const pitchEnv = ctx.createGain();
    const filter = ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=1200; filter.Q.value=0.5;
    const freqStart = tone; const freqEnd = 35;
    osc.type='sine'; osc.frequency.setValueAtTime(freqStart, t);
    // pitch drop via exponential freq
    osc.frequency.exponentialRampToValueAtTime(freqEnd, t+0.12);
    gain.gain.setValueAtTime(1.0, t);
    gain.gain.exponentialRampToValueAtTime(0.0001, t+0.35);
    osc.connect(filter); filter.connect(gain); gain.connect(drumBus);
    osc.start(t); osc.stop(t+0.5);
  }
  function noiseBuffer(){
    const buffer = ctx.createBuffer(1, ctx.sampleRate*1.5, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++){ data[i]=Math.random()*2-1; }
    return buffer;
  }
  const whiteNoise = noiseBuffer();

  function playSnare(t, noiseMix=0.6){
    // body
    const osc = ctx.createOscillator(); osc.type='triangle'; osc.frequency.setValueAtTime(190, t);
    const body = ctx.createGain(); body.gain.setValueAtTime(0.8, t); body.gain.exponentialRampToValueAtTime(0.001, t+0.18);
    // noise
    const ns = ctx.createBufferSource(); ns.buffer=whiteNoise; ns.loop=false;
    const nsg = ctx.createGain(); nsg.gain.setValueAtTime(noiseMix, t); nsg.gain.exponentialRampToValueAtTime(0.001, t+0.2);
    const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1500;
    osc.connect(body); body.connect(drumBus);
    ns.connect(hp); hp.connect(nsg); nsg.connect(drumBus);
    osc.start(t); osc.stop(t+0.22);
    ns.start(t); ns.stop(t+0.22);
  }
  function playHat(t, decay=0.12){
    const ns = ctx.createBufferSource(); ns.buffer=whiteNoise;
    const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; hp.Q.value=0.7;
    const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=8000; bp.Q.value=0.8;
    const amp = ctx.createGain(); amp.gain.setValueAtTime(0.4, t); amp.gain.exponentialRampToValueAtTime(0.0001, t+decay);
    ns.connect(hp); hp.connect(bp); bp.connect(amp); amp.connect(drumBus);
    ns.start(t); ns.stop(t+decay+0.01);
  }
  function playClap(t){
    // 3 short bursts of noise
    for(let i=0;i<3;i++){
      const ns = ctx.createBufferSource(); ns.buffer=whiteNoise;
      const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.6;
      const amp = ctx.createGain(); const start = t + i*0.012;
      amp.gain.setValueAtTime(0.5, start); amp.gain.exponentialRampToValueAtTime(0.001, start+0.1);
      ns.connect(bp); bp.connect(amp); amp.connect(drumBus);
      ns.start(start); ns.stop(start+0.12);
    }
  }

  // Synth
  const synthBus = ctx.createGain(); setDb(synthBus, -6);
  const synthFilter = ctx.createBiquadFilter(); synthFilter.type='lowpass'; synthFilter.frequency.value=1800; synthFilter.Q.value=1.2;
  // Delay
  const delay = ctx.createDelay(1.0); delay.delayTime.value=0.28;
  const delayFB = ctx.createGain(); delayFB.gain.value=0.35;
  const delayMix = ctx.createGain(); delayMix.gain.value=0.2;
  delay.connect(delayFB); delayFB.connect(delay);
  // Simple reverb via multi-tap diffuse network
  function makeReverb(){
    const merger = ctx.createGain();
    const taps = [0.031,0.071,0.113,0.173,0.227];
    taps.forEach((t,i)=>{
      const d=ctx.createDelay(1.0); d.delayTime.value=t;
      const g=ctx.createGain(); g.gain.value=0.35/(i+1);
      const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=4000/(i+1)*1.5;
      synthFilter.connect(d); d.connect(lp); lp.connect(g); g.connect(merger);
    });
    return merger;
  }
  const reverb = makeReverb();
  const reverbMix = ctx.createGain(); reverbMix.gain.value=0.15;

  synthBus.connect(synthFilter);
  synthFilter.connect(delay); delay.connect(delayMix); delayMix.connect(comp);
  synthFilter.connect(reverb); reverb.connect(reverbMix); reverbMix.connect(comp);
  synthFilter.connect(comp);

  const activeVoices = new Map(); // note -> {osc, gain}

  function noteToFreq(n){ return 440 * Math.pow(2, (n-69)/12); }

  function startNote(note, t=ctx.currentTime){
    const params = getADSR();
    const osc = ctx.createOscillator();
    const g = ctx.createGain(); g.gain.value=0.0001;
    osc.type = document.getElementById('wave').value;
    osc.frequency.value = noteToFreq(note);
    osc.connect(g); g.connect(synthBus);
    // ADSR
    g.gain.cancelScheduledValues(t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.linearRampToValueAtTime(1.0, t + params.a);
    g.gain.linearRampToValueAtTime(params.s, t + params.a + params.d);
    activeVoices.set(note, {osc, g});
    osc.start(t);
  }
  function stopNote(note, t=ctx.currentTime){
    const params = getADSR();
    const v = activeVoices.get(note);
    if(!v) return;
    v.g.gain.cancelScheduledValues(t);
    v.g.gain.setTargetAtTime(0.0001, t, Math.max(0.001, params.r/3));
    v.osc.stop(t + params.r + 0.02);
    setTimeout(()=>activeVoices.delete(note), (params.r+0.03)*1000);
  }
  function getADSR(){
    return {
      a: parseFloat(document.getElementById('a').value),
      d: parseFloat(document.getElementById('d').value),
      s: parseFloat(document.getElementById('s').value),
      r: parseFloat(document.getElementById('r').value)
    };
  }

  // Keyboard UI (C major-ish from C3)
  const keyMap = [
    {name:'C',  midi:48, white:true, kb:'Z'},
    {name:'C#', midi:49, white:false, kb:'S'},
    {name:'D',  midi:50, white:true, kb:'X'},
    {name:'D#', midi:51, white:false, kb:'D'},
    {name:'E',  midi:52, white:true, kb:'C'},
    {name:'F',  midi:53, white:true, kb:'V'},
    {name:'F#', midi:54, white:false, kb:'G'},
    {name:'G',  midi:55, white:true, kb:'B'},
    {name:'G#', midi:56, white:false, kb:'H'},
    {name:'A',  midi:57, white:true, kb:'N'},
    {name:'A#', midi:58, white:false, kb:'J'},
    {name:'B',  midi:59, white:true, kb:'M'},
  ];

  let octaveOffset=0;
  const keysDiv = document.getElementById('keys');

  function buildKeys(){
    keysDiv.innerHTML='';
    let whiteIdx=0;
    keyMap.forEach((k, idx)=>{
      if(k.white){
        const el = document.createElement('div'); el.className='white'; el.dataset.midi=k.midi;
        el.innerHTML = `<div style="position:absolute;bottom:6px;left:6px;font-size:11px;color:#222">${k.kb}</div>`;
        // if next is black, overlay
        const next = keyMap[idx+1];
        if(next && !next.white){
          const bl = document.createElement('div'); bl.className='black'; bl.dataset.midi=next.midi;
          el.appendChild(bl);
        }
        keysDiv.appendChild(el);
        whiteIdx++;
      }
    });
    keysDiv.querySelectorAll('.white, .black').forEach(el=>{
      el.addEventListener('mousedown', e=>{
        const midi = parseInt(e.target.dataset.midi) + octaveOffset*12;
        keyDown(midi, e.target);
      });
      el.addEventListener('mouseup', e=>{
        const midi = parseInt(e.target.dataset.midi) + octaveOffset*12;
        keyUp(midi, e.target);
      });
      el.addEventListener('mouseleave', e=>{
        const midi = parseInt(e.target.dataset.midi) + octaveOffset*12;
        keyUp(midi, e.target);
      });
    });
  }
  buildKeys();

  function highlightKey(midi, on){
    const base = midi - octaveOffset*12;
    const el = keysDiv.querySelector(`[data-midi="${base}"]`);
    if(!el) return;
    el.classList.toggle('active', !!on);
  }

  const keyToMidi = {}; keyMap.forEach(k=> keyToMidi[k.kb]=k.midi );
  const pressed = new Set();

  function keyDown(midi, el){
    if(pressed.has(midi)) return;
    pressed.add(midi);
    startNote(midi);
    if(el) el.classList.add('active'); else highlightKey(midi, true);
  }
  function keyUp(midi, el){
    if(!pressed.has(midi)) return;
    pressed.delete(midi);
    stopNote(midi);
    if(el) el.classList.remove('active'); else highlightKey(midi, false);
  }

  window.addEventListener('keydown', (e)=>{
    if(e.repeat) return;
    const k = e.key.toUpperCase();
    if(k==='SHIFT'){ octaveOffset=1; return; }
    if(k===' '){ e.preventDefault(); toggle(); return; }
    if(k in keyToMidi){
      keyDown(keyToMidi[k] + octaveOffset*12);
    }
  });
  window.addEventListener('keyup', (e)=>{
    const k = e.key.toUpperCase();
    if(k==='SHIFT'){ octaveOffset=0; return; }
    if(k in keyToMidi){
      keyUp(keyToMidi[k] + octaveOffset*12);
    }
  });

  // Params bindings
  bindRange('kickTone', (v)=>document.getElementById('kickToneVal').textContent=v);
  bindRange('snrNoise', (v)=>document.getElementById('snrNoiseVal').textContent=parseFloat(v).toFixed(2));
  bindRange('hatDecay', (v)=>document.getElementById('hatDecayVal').textContent=parseFloat(v).toFixed(2));
  bindRange('drumVol', (v)=>{ drumVolVal.textContent=v+' dB'; setDb(drumBus, parseFloat(v)); });
  bindRange('masterVol', (v)=>{ document.getElementById('masterVolVal').textContent=v+' dB'; setDb(masterGain, parseFloat(v)); });
  bindRange('cutoff', (v)=> synthFilter.frequency.value=parseFloat(v));
  bindRange('q', (v)=> synthFilter.Q.value=parseFloat(v));
  bindRange('delayMix', (v)=> delayMix.gain.value=parseFloat(v));
  bindRange('delayTime', (v)=> delay.delayTime.value=parseFloat(v));
  bindRange('reverb', (v)=> reverbMix.gain.value=parseFloat(v));
  bindRange('synthVol', (v)=> setDb(synthBus, parseFloat(v)));

  function bindRange(id, fn){
    const el = document.getElementById(id);
    fn(el.value);
    el.addEventListener('input', ()=>fn(el.value));
  }

  // Transport
  const bpmEl = document.getElementById('bpm');
  const swingEl = document.getElementById('swing');
  document.getElementById('play').onclick = ()=> toggle(true);
  document.getElementById('stop').onclick = ()=> stop();
  function toggle(forceOn){
    if(ctx.state==='suspended') ctx.resume();
    if(forceOn===true || !isPlaying){ play(); } else { stop(); }
  }
  function play(){
    if(isPlaying) return;
    isPlaying=true; schedule();
    document.getElementById('play').textContent='‚è∏ Pause';
  }
  function stop(){
    isPlaying=false; currentStep=0;
    document.getElementById('play').textContent='‚ñ∂Ô∏é Play';
    setPlayheadUI(-1);
    if(timer){ clearInterval(timer); timer=null; }
  }

  let nextNoteTime = 0;
  function schedule(){
    const stepDur = 60 / parseFloat(bpmEl.value) / 4; // 16th note
    if(nextNoteTime === 0){ nextNoteTime = ctx.currentTime + 0.05; }
    timer = setInterval(()=>{
      while(nextNoteTime < ctx.currentTime + scheduleAhead){
        // schedule current step
        tracks.forEach((t)=>{
          if(t.steps[currentStep]){
            // apply swing on even steps (1-based odd indices) for hats and claps for feel
            let when = nextNoteTime;
            const swing = parseFloat(swingEl.value)/100 * stepDur * 0.9;
            const isSwingStep = (currentStep % 2 === 1);
            if(isSwingStep) when += swing;
            switch(t.type){
              case 'kick': playKick(when, parseFloat(document.getElementById('kickTone').value)); break;
              case 'snare': playSnare(when, parseFloat(document.getElementById('snrNoise').value)); break;
              case 'hat': playHat(when, parseFloat(document.getElementById('hatDecay').value)); break;
              case 'clap': playClap(when); break;
            }
          }
        });
        setPlayheadUI(currentStep);
        nextNote();
        nextNoteTime += stepDur;
      }
    }, lookahead);
  }
  function nextNote(){
    currentStep = (currentStep + 1) % steps;
  }

  // Save/Load
  function getPattern(){
    return {
      bpm: parseFloat(bpmEl.value),
      swing: parseFloat(swingEl.value),
      tracks: tracks.map(t=>({name:t.name,type:t.type,steps:[...t.steps]})),
      params:{
        kickTone: parseFloat(document.getElementById('kickTone').value),
        snrNoise: parseFloat(document.getElementById('snrNoise').value),
        hatDecay: parseFloat(document.getElementById('hatDecay').value),
        drumVol: parseFloat(document.getElementById('drumVol').value),
        masterVol: parseFloat(document.getElementById('masterVol').value),
        wave: document.getElementById('wave').value,
        a: parseFloat(document.getElementById('a').value),
        d: parseFloat(document.getElementById('d').value),
        s: parseFloat(document.getElementById('s').value),
        r: parseFloat(document.getElementById('r').value),
        cutoff: parseFloat(document.getElementById('cutoff').value),
        q: parseFloat(document.getElementById('q').value),
        delayMix: parseFloat(document.getElementById('delayMix').value),
        delayTime: parseFloat(document.getElementById('delayTime').value),
        reverb: parseFloat(document.getElementById('reverb').value),
        synthVol: parseFloat(document.getElementById('synthVol').value),
      }
    };
  }
  function setPattern(p){
    bpmEl.value = p.bpm ?? 110;
    swingEl.value = p.swing ?? 0;
    p.tracks?.forEach((t, i)=>{
      if(tracks[i]) tracks[i].steps = t.steps.slice(0,steps);
    });
    // update UI grid to reflect states
    buildGrid();
    // re-bind playhead visual each time step toggles
    document.querySelectorAll('.step').forEach(btn=>{
      const ri = parseInt(btn.dataset.ri), i = parseInt(btn.dataset.i);
      if(tracks[ri].steps[i]) btn.classList.add('on');
    });
    // params
    const pm = p.params||{};
    for(const k in pm){
      const el = document.getElementById(k);
      if(el){ el.value = pm[k]; el.dispatchEvent(new Event('input')); }
    }
  }

  document.getElementById('save').onclick = ()=>{
    const p = getPattern();
    localStorage.setItem('beatsynth_pattern', JSON.stringify(p));
    flash('Saved to localStorage.');
  };
  document.getElementById('load').onclick = ()=>{
    const s = localStorage.getItem('beatsynth_pattern');
    if(!s) return flash('No saved pattern found.');
    setPattern(JSON.parse(s));
    flash('Loaded from localStorage.');
  };
  document.getElementById('exportJSON').onclick = ()=>{
    const p = getPattern(); const txt = JSON.stringify(p, null, 2);
    const box = document.getElementById('patternBox'); box.value = txt;
    const blob = new Blob([txt], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download='beatsynth-pattern.json'; a.click();
  };
  const importInput = document.getElementById('importJSON');
  document.getElementById('importBtn').onclick = ()=> importInput.click();
  importInput.onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{
        const p = JSON.parse(r.result);
        setPattern(p);
        document.getElementById('patternBox').value = JSON.stringify(p, null, 2);
        flash('Pattern imported.');
      }catch(err){ flash('Invalid JSON.'); }
    };
    r.readAsText(f);
  };

  // Recording
  document.getElementById('rec').onclick = ()=>{
    if(!mediaRecorder || mediaRecorder.state==='inactive'){
      recordedChunks=[];
      mediaRecorder = new MediaRecorder(mediaDest.stream);
      mediaRecorder.ondataavailable = (e)=>{ if(e.data.size>0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(recordedChunks, {type:'audio/webm'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'beatsynth-recording.webm';
        a.click();
      };
      mediaRecorder.start();
      recLed.classList.add('on');
      flash('Recording‚Ä¶');
    } else if(mediaRecorder.state==='recording'){
      mediaRecorder.stop();
      recLed.classList.remove('on');
      flash('Recording saved.');
    }
  };

  // Little UX helpers
  function flash(msg){
    const div = document.createElement('div');
    div.textContent = msg;
    div.style.position='fixed'; div.style.bottom='16px'; div.style.left='50%'; div.style.transform='translateX(-50%)';
    div.style.background='#0e1222'; div.style.border='1px solid #2a2e42'; div.style.padding='8px 12px'; div.style.borderRadius='8px'; div.style.color='#dfe6ff';
    div.style.boxShadow='0 6px 20px rgba(0,0,0,.35)'; div.style.zIndex='9999';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(), 1400);
  }

  // Init default groove
  const demo = {
    bpm:110, swing:12,
    tracks:[
      {name:'Kick',type:'kick',steps:[true,false,false,false, true,false,false,false, true,false,false,false, true,false,false,false]},
      {name:'Snare',type:'snare',steps:[false,false,false,false, true,false,false,false, false,false,false,false, true,false,false,false]},
      {name:'Hat',type:'hat',steps:Array(16).fill(true).map((v,i)=> i%2===0 )},
      {name:'Clap',type:'clap',steps:[false,false,false,false, false,false,false,false, false,false,false,false, false,false,false,true]}
    ],
    params:{ kickTone:60, snrNoise:0.62, hatDecay:0.12, drumVol:-2, masterVol:-6, wave:'sawtooth', a:0.01, d:0.2, s:0.6, r:0.5, cutoff:2200, q:1.5, delayMix:0.2, delayTime:0.28, reverb:0.15, synthVol:-6 }
  };
  setPattern(demo);

})();</script>
</body>
</html>
